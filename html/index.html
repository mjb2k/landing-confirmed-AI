<html>
    <head>
        <meta charset="UTF-8">
        <title>Landing Confirmed Game</title>
        <style>
            body {
                background-color: red;
            }
        </style>
    </head>


    <body onload="init()">
        <script src="libraries/matter.js"></script>
        <script src="libraries/bodyRotateAroundPoint.js"></script>
        <script src="libraries/raycast.min.js"></script>
        <script src="main.js"></script>
        <script src="player.js"></script>

        <button onclick="addPlayer()"></button>
        <button onclick=""></button>
        <script>
            // this script tells us what a user is pressing.
            var map = {}; 
            onkeydown = onkeyup = function(e){
                map[e.keyCode] = e.type == 'keydown';
            }
        </script>
        <script>

            // we need to keep track of the previous velocity of the player 
            Matter.Events.on(runner, 'beforeTick', function () {
                player.updatePreVelocity();
            });

            // post tick actions.
            Matter.Events.on(runner, 'afterTick', function() {

                // issue commands to the ship based on what player is pressing.
                if (map[65] && !map[68]) { // A pressed down
                    player.leftThrust();
                }  
                else if (!map[65] && map[68]) { // D pressed down
                    player.rightThrust();
                }
                else if (map[65] && map[68]) { // both pressed down
                    player.fullThrust();
                }
                
                // This code is used to raise or lower the landing gears
                var thrusterD = player.thrusterDelta(); // gets how close thruster is to ground
                var up = false, down = false;
                var deltaToLeftGear = Matter.Vector.magnitude(Matter.Vector.sub(player.mainBody.position, player.leftGear.position));
                var deltaToRightGear = Matter.Vector.magnitude(Matter.Vector.sub(player.mainBody.position, player.rightGear.position));
                // distance within an error bound, we know our gears are up or down.
                if ((deltaToLeftGear > 36.65 && deltaToLeftGear < 37.25) || 
                    (deltaToRightGear > 36.65 && deltaToRightGear < 37.25)) {
                    up = true;
                }
                else if ((deltaToLeftGear > 75.45 && deltaToLeftGear < 76.85) || 
                    (deltaToRightGear > 75.45 && deltaToRightGear < 76.85)) {
                    down = true;
                }

                // if sufficiently far from the ground and the angle of 
                // our landing gears is not already aligned we shall rotate them
                // to completely retract.
                if ((thrusterD > 100 || (thrusterD == -1)) && !up) {
                    player.retractGears();
                }

                // if sufficiently close and the angle of gears is not 
                // already extended then we shall extend them.
                else if (thrusterD < 100 && thrusterD != -1 && !down
                    && player.parts.indexOf(player.rightGear) != -1) {
                    player.extendGears();
                }

                // now we detect collisions between the players body parts and the level
                var mainBodyCollisions = Matter.Query.collides(player.mainBody, objects);
                var leftCollideWithMainBody = Matter.Collision.collides(player.mainBody, player.leftGear);
                if (leftCollideWithMainBody == null) player.leftTouching = false;
                var rightCollideWithMainBody = Matter.Collision.collides(player.mainBody, player.rightGear);
                if (rightCollideWithMainBody == null) player.rightTouching = false;
                if (mainBodyCollisions.length >= 1) { // we have a collision with the mainBody

                    // if we have a collisino with the gears we need to make sure the gears 
                    // have been separated from the body at some point to register this as death.
                    if (leftCollideWithMainBody != null) {
                        if (leftCollideWithMainBody.collided && !player.leftTouching)
                            console.log("death");
                    }
                    if (rightCollideWithMainBody != null) {
                        if (rightCollideWithMainBody.collided && !player.rightTouching)
                            console.log("death");
                    }
                    else { // if there's a still collision (just not with the gears) it means death)
                        console.log("death");
                    }
                    //Matter.World.remove(engine.world, player.fullBody);
                }
                
                // Remember F = ma, or F = m * ((v2 - v1)/t), t= 1/60 always (FPS)
                // calculate acceleration 
                var acc = Matter.Vector.mult(Matter.Vector.sub(player.fullBody.velocity, player.preVelocity), 60);
                var f = Matter.Vector.magnitude(Matter.Vector.mult(acc, player.fullBody.mass));

                // detect collisions with the leftGear, rightGear and thrusterBody
                var leftGearCollisions = Matter.Query.collides(player.leftGear, [ground]);
                var rightGearCollisions = Matter.Query.collides(player.rightGear, [ground]);
                var thrusterBodyCollisions = Matter.Query.collides(player.thrusterBody, [ground]);

                // collision with left gear
                // player.fullBody.parts.indexOf(player.leftGear) != -1
                if (leftGearCollisions.length >= 1 && 
                    player.parts.indexOf(player.leftGear) != -1 && 
                    f> 1000) {
                    player.removeLeftGear();         
                }
                if (rightGearCollisions.length >= 1 && 
                    player.parts.indexOf(player.rightGear) != -1 &&
                    f > 1000) {
                    player.removeRightGear();     
                }

                
            });
        </script>
    </body>

</html>